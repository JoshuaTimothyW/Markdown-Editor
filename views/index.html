<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor</title>
    
    <link rel="stylesheet" href="static/css/toastui-editor.min.css">
    <link rel="stylesheet" href="static/css/toastui-editor-dark.min.css">
    <script src="static/js/toastui-editor-all.min.js"></script>

    <link rel="stylesheet" href="static/css/style.css">
    <link rel="icon" type="image/x-icon" href="static/img/markdown.ico"> 
</head>
<body class="container-fluid">
    <div class="navbar">
        <div id="mySidenav" class="sidenav">
            <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
            <div id="list-files">
                <strong class="selected">test 1</strong>
                <a href="">test 2</a>
                <a href="">test 3</a>
            </div>
            <!-- <button class="btn btn-success" onclick="toggle_modal()">New File</button> -->
        </div>
        <span onclick="openNav()" class="menu-bar">
            <svg viewBox="0 0 100 80" width="40" height="40">
                <rect width="100" height="5" ></rect>
                <rect y="30" width="75" height="5" ></rect>
                <rect y="60" width="45" height="5" ></rect>
            </svg>
        </span>
        <h2 id="filename" class="title"></h2>
        <div class="float-right">
            <div id="status" class="tag">Status: Saved</div>
            <button id="btn-save" type="button" class="btn btn-primary" onclick="save()" disabled >Save</button>
        </div>
    </div>

    <div id="editor"></div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close">&times;</span>
                <h2>New File</h2>
                <input type="text" id="text-input" class="form-control">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" style="width: 100%;" onclick="new_file()" >Save</button>
            </div>
        </div>
    </div>
</body>
<script>

    var title = "";
    var filepath = "";

    const editor = new toastui.Editor({
        el: document.querySelector('#editor'),
        previewStyle: 'vertical',
        height: '500px',
        theme: 'dark',
    });

    function click_link(url) {
        closeNav();
        getContent(url);
    }

    async function getContent(url) {
        const res = await fetch(url);
        let data = await res.json();
        let txt;

        console.log(data);

        title = data["Title"];
        
        if(title){
            document.getElementById("btn-save").removeAttribute('disabled') = false;
        }
        
        // list files
        data["List_files"].forEach( el => {
            if( el.Filename === title ){
                txt += 
                "<strong class='selected'>"+el.Filename+"</strong>";
            }else{
                txt += 
                "<a href='/edit?path="+el.Filepath+"' >"+el.Filename+"</a>"; 
            }
        });

        document.getElementById("list-files").innerHTML = txt;
        
        // set title
        document.getElementById("filename").innerHTML = title;

        // set filepath
        filepath = data["CurrentPath"];

        // set content to markdown editor
        editor.setMarkdown(data["Content"]);
    }

    // call get content method
    getContent("/read");

    // hide status
    document.getElementById('status').style.display = "none";

    /* Set the width of the side navigation to 250px */
    function openNav() {
        // document.getElementById("mySidenav").style.display = "block"; 
        document.getElementById("mySidenav").style.width = "350px";
        document.getElementById("editor").style.marginLeft = "350px";
    }
    
    /* Set the width of the side navigation to 0 */
    function closeNav() {
        // document.getElementById("mySidenav").style.display = "none"; 
        document.getElementById("mySidenav").style.width = "0px";
        document.getElementById("editor").style.marginLeft = "0px";
    }

    // Save function
    async function save() {

        let content = editor.getMarkdown();

        let data = new FormData();

        data.append("Filepath",filepath);
        data.append("Content",content);

        fetch("/",{
            method: 'POST',
            body: data,
        })
        .then( (res) => {
            console.log(res.json());
            document.getElementById('status').style.display = "";

            setTimeout(() => {
                document.getElementById('status').style.display = "none";
            }, 3000);
        })
        .catch( (err) => {
            let link = document.createElement('a');
            mimeType = 'text/html' || 'text/plain';
    
            link.setAttribute('download', title+".md");
            link.setAttribute('href', 'data:' + mimeType  +  ';charset=utf-8,' + encodeURIComponent(content));
            link.click();
        })

    }

    // New File
    async function toggle_modal() {
        let modal = document.getElementById("modal");
        let status = modal.style.display;

        if(status == "block"){
            modal.style.display = "none";
        }else{
            modal.style.display = "block";
        }
    }

    
    // Rename file
    async function rename() {
        filepath = filepath+title;
        await save();
        window.location.href = "/edit?path="+filepath;
    }

    // New File
    async function new_file(){
        toggle_modal();
        title = document.getElementById("text-input").value;
        rename();
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    } 

</script>
</html>